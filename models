from sqlalchemy import (
    Column, Integer , String, TIMESTAMP, Text , ForeignKey , Boolean , UniqueConstraint, DateTime , DATETIME
)

from sqlalchemy.orm import relationship, declarative_base
from datetime import datetime ,timezone


Base = declarative_base()


class User(Base):
    __tablename__ = "users"

    user_id = Column(Integer, primary_key=True , index = True)
    user_licensenumber = Column(String(14), unique=True, nullable=False)
    user_fname = Column(String(25), nullable=False)
    user_lname = Column(String(25), nullable=False)
    user_phonenumber = Column(String(14), nullable=False)
    user_email = Column(String(30))

    user_password = Column(String(255))

    notifications = relationship("Notification", back_populates="user")
    ownerships = relationship("VehicleOwnership", back_populates="user")

class TrafficPersonnel(Base):
    __tablename__ = "TrafficPersonnel"

    tp_personnelId = Column(Integer, primary_key=True)
    tp_fname = Column(String(50), nullable=False)
    tp_lname = Column(String(50), nullable=False)
    tp_phonenumber = Column(String(14), nullable=False)

    videos = relationship("Video", back_populates="uploader")


class Video(Base):
    __tablename__ = "Video"

    video_id = Column(Integer, primary_key=True)
    video_path = Column(String(255))
    uploadtime_stamp = Column(TIMESTAMP)
    uploadedbyID = Column(Integer, ForeignKey("TrafficPersonnel.tp_personnelId"))

    uploader = relationship("TrafficPersonnel", back_populates="videos")
    violations = relationship("RuleViolation", back_populates="video")


class Vehicle(Base):
    __tablename__ = "vechicle"

    vechicle_id = Column(Integer, primary_key=True)
    vechicle_type = Column(String(25))
    licenceplate_number = Column(String(30))

    ownerships = relationship("VehicleOwnership", back_populates="vehicle")
    violations = relationship("RuleViolation", back_populates="vehicle")


class VehicleOwnership(Base):
    __tablename__ = "VehicleOwnership"

    ownership_id = Column(Integer, primary_key=True)
    current_ownership = Column(Boolean)
    vechicle_id = Column(Integer, ForeignKey("Vechicle.vechicle_id"))
    user_licenseNumber = Column(String(14), ForeignKey("users.user_licensenumber"))

    vehicle = relationship("Vehicle", back_populates="ownerships")
    user = relationship("User", back_populates="ownerships")

class Notification(Base):
    __tablename__ = "notification"

    notification_id = Column(Integer, primary_key=True, index=True)
    notification_message = Column(Text, nullable=False)
    notification_senttimestamp = Column(DateTime, default=lambda: datetime.now(timezone.utc), nullable=False)
    notification_status = Column(String(20), nullable=False)
    violation_id = Column(Integer, ForeignKey("ruleviolation.violation_id"))
    user_licensenumber = Column(String(14), ForeignKey("users.user_licensenumber"), nullable=False)

    user = relationship("User", back_populates="notifications")
    violation = relationship("RuleViolation", back_populates="notifications")




class RuleViolation(Base):
    __tablename__ = "ruleviolation"

    violation_id = Column(Integer, primary_key=True)
    violation_type = Column(String(30))
    violation_timesstamp = Column(TIMESTAMP)
    violation_status = Column(String(20))
    vechicle_id = Column(Integer, ForeignKey("Vechicle.vechicle_id"))
    video_id = Column(Integer, ForeignKey("Video.video_id"))

    vehicle = relationship("Vehicle", back_populates="violations")
    video = relationship("Video", back_populates="violations")
    notifications = relationship("Notification", back_populates="violation")